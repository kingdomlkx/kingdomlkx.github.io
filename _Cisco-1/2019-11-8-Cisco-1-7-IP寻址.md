---
title: Cisco-1-7 IP寻址
auther: 雁引愁心去
layout: post
order: 7
---


## 第七章 IP寻址 ##






### 第一节 IPv4 网络地址 ###
1. 每一个地址包含一串 32 位字符串，并分为四个部分，称为 八位字节.每一个二进制八位数包含 8 位（或 1 个字节），用句点分隔。
2. 网络部分和主机部分
  - Pv4 地址为分层地址，由网络部分和主机部分两个部分组成。对于同一网络中的所有设备，地址的网络部分中的位必须完全相同。地址的主机部分中的位必须唯一，这方便识别网络中的特定主机。

  - 子网掩码 - 为了确定 IPv4 地址的网络部分和主机部分，要将子网掩码与 IPv4 地址进行从左到右逐位比较（如图 3 所示）。子网掩码中的 1 代表网络部分，而 0 则代表主机部分。注意子网掩码本质上是一个 1 位序列后接 0 位序列的序列。子网掩码实际上不包含 IPv4 地址的网络部分或主机部分，它仅通知计算机如何在给定的 IPv4 地址中查找这些部分。

  ![子网掩码](/assets/images/cisco1/7-子网掩码和前缀长度.png)

  - 用于确定网络部分和主机部分的实际流程叫做 AND 运算

3. 逻辑AND运算

![逻辑AND运算](/assets/images/cisco1/7-逻辑AND运算.png)

  - 逻辑 AND 运算是数字逻辑中使用的三种基本二进制运算之一。另外两种是 OR 和 NOT.
  - 逻辑 AND 运算比较两个位,注意只有 1 AND 1 等于 1.
  - 要确定 IPv4 主机的网络地址，应将 IPv4 地址与子网掩码逐位进行逻辑 AND 运算。地址和子网掩码之间的 AND 运算得到的结果就是网络地址
  - 可选择的确定子网掩码的速记法，即前缀长度。例如: /24(255.255.255.0)
4. 网络,主机和广播地址
  - 网络地址 - 地址和子网掩码引用同一个网络.该网络中的所有主机共享同一个为网络地址.主机部分全为0.(例如:192.168.10.0/24  .00000000)
  - 主机地址
  主机部分包含0和1(例如:从 .00000001到.11111110)
    - 第一个主机地址 - 主机部分全为0,并以1结尾.(例如 .00000001)
    - 最后一个主机地址 - 主机部分全为1,并以0结尾.(例如: .11111110)
  - 广播地址 -   主机部分全部为1(例如: .11111111)
5. IPv4通信
  - 单播传输
  - 广播传输  - 发送广播时，数据包以 __主机部分全部为 1 的地址__ 作为目的 IPv4 地址.当主机收到发送到网络广播地址的数据包时，主机处理该数据包的方式与处理发送到单播地址的数据包的方式相同。默认情况下，路由器不转发广播。
  - 组播传输 - IPv4 将 224.0.0.0 到 239.255.255.255 的地址保留为组播范围。IPv4 组播地址 224.0.0.0 到 224.0.0.255 是专为本地网络的组播保留的。这些地址将用于本地网络中的组播组。连接到本地网络的路由器识别出这些数据包的目的地址为本地网络组播组，从而不再将它们发送到别处。接收特定组播数据的主机称为组播客户端。组播客户端使用客户端程序请求的服务来加入组播组。
6. 公有和私有IPv4地址
具体来说，私有地址块为：
  - 10.0.0.0 /8 或 10.0.0.0 到 10.255.255.255
  - 172.16.0.0 /12 或 172.16.0.0 到 172.31.255.255
  - 192.168.0.0 /16 或 192.168.0.0 到 192.168.255.255
必须知道这些地址块中的地址不能用于互联网，必须由互联网路由器过滤（丢弃）
网络地址转换 (NAT) 用于私有 IPv4 地址和公有 IPv4 地址间的转换。 __这通常是在将内部网络连接到 ISP 网络的路由器上完成__。
7. 特殊用户IPv4地址
  - 环回地址（127.0.0.0 /8 或 127.0.0.1 到 127.255.255.254）– 更常见的是仅确定为 127.0.0.1，主机使用这些特殊地址将流量指向其自身。
  - 本地链路地址（169.254.0.0 /16 或 169.254.0.1 到 169.254.255.254）– 通常被称为自动专用 IP 地址 (APIPA) 地址.Windows DCHP 客户端在无可用 DHCP 服务器时，使用它们进行自我配置。在对等连接中非常有用。
  - TEST-NET 地址（192.0.2.0/24 或 192.0.2.0 到 192.0.2.255）– 这些地址留作教学使用，用于文档和网络示例。
8. 传统有类编址
  - A 类（0.0.0.0/8 至 127.0.0.0/8）.所有 A 类地址要求高位二进制八位数的最高有效位必须为零，以生成总数为 128 的 A 类网络.注意:0.0.0.0与127.0.0.0不能分配.
  - B 类 (128.0.0.0 /16 – 191.255.0.0 /16) .它的两个高位二进制八位数使用固定的 /16 前缀表示网络地址，其他的两个二进制八位数表示主机地址。高位二进制八位数的两个最高有效位必须为 10.
  - C 类 (192.0.0.0 /24 – 223.255.255.0 /24) .它的前三个二进制八位数使用固定的 /24 前缀表示网络地址，其余的二进制八位数表示主机地址。高位二进制八位数的前三个最高有效位必须为 110.
9. 无类编址

IPv4耗尽日期

![7-RIR_IPv4耗尽日期.png](/assets/images/cisco1/7-RIR_IPv4耗尽日期.png)

### 第二节 IPv6网络地址 ###
1. IPv4和IPvv6共存
  - 双堆栈 – 双堆栈允许 IPv4 和 IPv6 在同一网络中共存。双堆栈设备同时运行 IPv4 和 IPv6 协议栈。
  - 隧道 – 隧道是在 IPv4 网络中传输 IPv6 数据包的一种方法。IPv6 数据包封装在 IPv4 数据包中，类似于其他类型的数据。
  - 转换 – 网络地址转换 64 (NAT64) 允许支持 IPv6 的设备使用与 IPv4 NAT 类似的方法与支持 IPv4 的设备通信。IPv6 数据包转换为 IPv4 数据包，反之亦然。
  隧道和转换仅在需要时使用。目标是从源到目的地进行本地 IPv6 通信。
2. IPv6地址表示方法
  - IPv6 地址长度为 128 位，写作十六进制值字符串，每 4 位以一个十六进制数字表示，共 32 个十六进制值。
  - 首选格式 - 书写 IPv6 地址的首选格式为 x: x: x: x: x: x: x: x，每个“x”均包括四个十六进制值。
  - 两个规则，帮助减少书写 IPv6 地址所需的位数。
    - 规则 1 - 忽略前导 0
    - 规则 2 - 忽略全 0 数据段.使用双冒号 (::) 替换任何由一个或多个全由 0 组成的16 位数据段（十六进制数）组成的连续字符串.双冒号 (::) 仅可在每个地址中使用一次，否则可能会得出一个以上的地址。
3. IPv6地址类型
  - 单播
  - 组播
  - 任播    
  与 IPv4 不同，IPv6 没有广播地址。但是，IPv6 具有 IPv6 全节点组播地址，这在本质上与广播地址的效果相同。
4. IPv6前缀长度
Pv6 使用前缀长度表示地址的前缀部分。IPv6 不使用点分十进制子网掩码记法。使用前缀长度表示使用 IPv6 __地址/前缀长度__ 的 IPv6 地址的网络部分。    
前缀长度范围为 0 至 128。LAN 和大多数其他网络类型的典型 IPv6 前缀长度为 /64。这意味着地址前缀或网络部分的长度为 64 位，为该地址的接口 ID（主机部分）另外保留 64 位。
5. IPv6单播地址
  ![IPv6单播地址](/assets/images/cisco1/7-IPv6单播地址.png)
  - 全局单播(GUA) - 全局单播地址类似于公有 IPv4 地址。这些地址具有全局唯一性，是互联网可路由的地址。全局单播地址可以静态配置也可动态分配。
  - 本地链路 - 本地链路地址用于与同一链路中的其他设备通信。在 IPv6 中，术语链路是指子网。本地链路地址仅限于单个链路。它们的唯一性仅在该链路上得到保证，因为它们在该链路之外不具有可路由性。换句话说，路由器不会转发具有本地链路源地址或目的地址的数据包。
  - 唯一本地 - 单播地址的另一种类型是唯一本地单播地址。IPv6 唯一本地地址与 IPv4 的 RFC 1918 私有地址具有相似之处，但是也有着重大差异。唯一本地地址用于一个站点内或数量有限的站点之间的本地编址。这些地址在全局 IPv6 上不可路由，不应转换为全局 IPv6 地址。唯一本地地址的范围是从 FC00::/7 到 FDFF::/7
6. IPv6本地链路地址的用途
  - IPv6 本地链路地址允许设备与同一链路上支持 IPv6 的其他设备通信，并且只能在该链路（子网）上通信。具有源或目标本地链路地址的数据包不能在数据包的源链路之外进行路由。    
  - 支持 IPv6 的主机会创建 IPv6 本地链路地址，即使没有为该设备分配 IPv6 全局单播地址。这允许支持 IPv6 的设备与同一子网中的其他支持 IPv6 的设备通信。这包括与默认网关（路由器）的通信。通常情况下，用作链路上其他设备的默认网关的是路由器的本地链路地址而不是全局单播地址。    
  - IPv6 本地链路地址属于 FE80::/10 范围。/10 表示前 10 位是 1111 1110 10xx xxxx。第一个十六进制数的范围是 1111 1110 1000 0000 (FE80) 到 1111 1110 1011 1111 (FEBF)。
7. IPv6 全局单播地址的结构     
IPv6 全局单播地址 (GUA) 具有全局唯一性，可在 IPv6互联网上路由。    
全局单播地址有三个部分：
  - 全局路由前缀    
    - 全局路由前缀为提供商（如 ISP）分配给客户或站点的地址的前缀或网络部分。一般来说，RIR 向客户分配 /48 全局路由前缀。这包括从公司企业网络到单个家庭网络中的每个站点。/48 前缀是分配的最常见全局路由前缀.

  - 子网 ID - 组织使用子网 ID 确定其站点的子网。子网 ID 越大，可用子网越多。
  - 接口 ID - IPv6 接口 ID 相当于 IPv4 地址的主机部分。使用术语“接口 ID”是因为单个主机可能有多个接口，而每个接口又有一个或多个 IPv6 地址。
8. 全局单播地址的静态配置    
  - 路由器配置 - 唯一区别是命令中使用 ipv6 取代 ip。    用于为接口配置 全局单播地址的命令是 `ipv6 address ipv6-address/prefix-length`.
  - 主机配置 - 默认网关地址可以是同一网络中与主机相连的路由器 GigabitEthernet 接口的全局单播地址.也可以置默认网关地址以与路由器 GigabitEthernet 接口的本地链路地址相匹配.
9. 动态配置
  - SLAAC(无状态地址自动配置)      
  IPv6 路由器每 200 秒定期将 ICMPv6 RA 消息发送到网络上所有支持 IPv6 的设备。在响应发送 ICMPv6 路由器请求 (RS) 消息的主机时，也会发送 RA 消息。   
  注意:默认情况下未启用 IPv6 路由。要将路由器启用为 IPv6 路由器，必须使用 __`ipv6 unicast-routing`__ 全局配置命令。   
  ICMPv6 RA 消息包括：   
    - 网络前缀和前缀长度 – 告知设备其所属的网络。   
    - 默认网关 – IPv6 本地链路地址，RA 消息的源 IPv6 地址。   
    - DNS 地址和域名 – DNS 服务器的地址和域名。        
  RA 选项 1：SLAAC:       
  借助 SLAAC，客户端设备使用 RA 消息中的信息创建其自己的全局单播地址。如图 2 所示，地址的两部分生成如下：      
  前缀 – RA 消息中接收     
  接口 ID – 使用 EUI-64 流程或通过生成一个随机 64 位数字产生。     
  - DHCPv6
    - RA 选项 2：SLAAC 和无状态 DHCPv6     
    通过此选项，RA 消息给予设备以下提示：    
      - 使用 SLAAC 创建其自己的 IPv6 全局单播地址.      
      - 使用路由器的本地链路地址，即默认网关地址的 RA 的源 IPv6 地址。      
      - 使用无状态 DHCPv6 服务器获取其他信息，例如 DNS 服务器地址和域名。     
    使用无状态 DHCPv6 服务器分配 DNS 服务器地址和域名。它不分配全局单播地址。     
    - A 选项 3：有状态 DHCPv6   
    有状态 DHCPv6 与 IPv4 的 DHCP 相似。使用有状态 DHCPv6 服务器的服务，设备可自动接收编址信息，包括全局单播地址、前缀长度和 DNS 服务器地址。     
    通过此选项，RA 消息给予设备以下提示：      
      - 使用路由器的本地链路地址，即默认网关地址的 RA 的源 IPv6 地址。      
      - 使用有状态 DHCPv6 服务器获取全局单播地址、DNS 服务器地址、域名和所有其他信息。     
    使用有状态 DHCPv6 服务器分配并维持哪台设备接收哪个 IPv6 地址的清单。IPv4 的 DHCP 是有状态的。     
  注意：默认网关地址仅可从 RA 消息中动态获取。无状态或有状态 DHCPv6 服务器均不提供默认网关地址
  - EUI-64 流程和随机生成
10. 动态本地链路地址    
所有的 IPv6 设备必须具有 Ipv6 本地链路地址。本地链路地址可以动态创建，也可作为静态本地链路地址手动配置。
当为接口分配全局单播地址时，思科路由器会自动创建 IPv6 本地链路地址。默认情况下，思科 IOS 路由器使用 EUI-64 为 IPv6 接口上的所有本地链路地址生成接口 ID。对于串行接口，路由器会使用以太网接口的 MAC 地址.为了更容易在路由器上识别和记忆这些地址，通常要在路由器上静态配置 IPv6 本地链路地址。    
11. 静态本地链路地址    
`interface address fe80::1 link-local`        
可以在各个链路上配置 FE80::1，因为它仅需在单个链路上保持唯一性。    
12. 检验IPv6地址配置      
  - `show ipv6 interface brief`       
  显示各个接口的缩略输出。与接口位于同一行的 [up/up] 输出指示第 1 层/第 2 层接口状态。这与同等的 IPv4 命令中的状态和协议列相同。注意,每个接口有两个 IPv6 地址。每个接口的第二个地址是配置的全局单播地址。第一个地址以 FE80 开头，是接口的本地链路单播地址。回想一下，分配全局单播地址后，本地链路地址会自动添加到接口。
  另请注意，R1 的 Serial 0/0/0 本地链路地址与其 GigabitEthernet 0/0 接口相同。串行接口没有以太网 MAC 地址，因此思科 IOS 使用第一个可用的以太网接口的 MAC 地址。这样可行，因为本地链路接口仅在该链路上具有唯一性。路由器接口的本地链路地址通常是该链路或网络上设备的默认网关地址.
  - `show ipv6 route`   
  路由表中，路由旁边的 C 表示这是一个直连网络。当路由器接口配置了全局单播地址并处于“up/up”状态时，IPv6 前缀和前缀长度会作为直连路由添加至 IPv6 路由表。   
  注意：L 表示本地路由，即为接口分配的特定 IPv6 地址。这不是本地链路地址。由于本地链路地址不是可路由地址，因此本地链路地址不包括在路由表中。   
  接口上配置的 IPv6 全局单播地址也作为本地路由添加到路由表中。本地路由具有 /128 前缀。路由表使用本地路由来有效处理目的地址为路由器接口地址的数据包。   
  从路由器对本地链路地址实施 ping 命令时，思科 IOS 会提示用户确认出接口。由于目的本地链路地址可以在一个或多个链路或网络上使用，路由器需要知道要将 ping 发送到哪个接口。   
13. 分配的IPv6组播地址
IPv6 组播地址的前缀为 FF00::/8。   
  - IPv6 组播地址分为两种类型：
    - 分配的组播   
    分配的组播地址是为预先定义的设备组保留的组播地址。分配的组播地址是用于到达运行通用协议或服务的设备组的单个地址。分配的组播地址用在特定的协议环境，例如 DHCPv6。
      - FF02::1 全节点组播组 – 这是一个包含所有支持 IPv6 的设备的组播组。发送到该组的数据包由该链路或网络上的所有 IPv6 接口接收和处理。
      - FF02::2 全路由组播组 – 这是一个所有 IPv6 路由器均会加入的组播组。使用 ipv6 unicast-routing 全局配置命令将路由器启用为 IPv6 路由器后，该路由器即成为该组播组的一员。发送到该组的数据包由该链路或网络上的所有 IPv6 路由器接收和处理。
    - 请求的节点组播
      - 请求节点组播地址的优势在于它被映射到特殊的以太网组播地址。这使得以太网网卡可以通过检查目的 MAC 地址过滤该帧，而不是将它发送给 IPv6 流程来判断该设备是否是 IPv6 数据包的既定目标。

### 第三节 验证连接 ###
1. ICMPv4和ICMPv6    
虽然 IP 并非尽力传输协议，TCP/IP 协议簇却会在发生某些错误时提供要发送的消息。这些消息使用 ICMP 服务发送。其用途是就特定情况下处理 IP 数据包的相关问题提供反馈，而并非是使 IP 可靠。ICMP 消息并非必需的，而且在网络内通常出于安全原因而被禁止。    
ICMP 消息的类型及其发送原因非常多。我们将介绍其中比较常见的一些消息。
ICMPv4 和 ICMPv6 通用的 ICMP 消息包括：
  - 主机确认    
  ICMP 回应消息可用于确定主机是否运行正常。本地主机向一台主机发送 ICMP 回应请求。如果主机可用，目的主机会回应以响应应答。如此使用 ICMP 回应消息是 ping 实用程序的基础。    
  - 目标或服务不可达    
  当主机或网关收到无法传送的数据包时，它会使用 ICMP 目的地不可达消息通知源主机，目标或服务无法到达。消息包括指示数据包为何无法传送的代码。
  ICMPv4 的目的地不可达代码示例有：
    - 0 - 网络不可达。
    - 1 - 主机不可达。
    - 2 - 协议不可达。
    - 3 - 端口不可达。
  - 超时    
  路由器使用 ICMPv4 超时消息表明，因为数据包的生存时间 (TTL) 字段递减到 0 而不能转发数据包。如果路由器接收数据包并且将 IPv4 数据包的 TTL 字段的值递减为零，则它会丢弃数据包并向源主机发送超时消息。   
  如果路由器因数据包过期而无法转发 IPv6 数据包，ICMPv6 也会发送超时消息。IPv6 没有 TTL 字段；它使用跳数限制字段来确定数据包是否过期。
  - 路由重定向
2. ICMPv6路由器请求和路由器通告消息     
![IPv6路由器请求和路由器通告消息](/assets/images/cisco1/7-IPv6路由器请求和路由器通告消息.png)       
  ICMPv6 在邻居发现协议（ND 或 NDP）中包括四个新协议。
    - IPv6 路由器和 IPv6 设备间的消息：
      - 路由器请求 (RS) 消息
      - 路由器通告 (RA) 消息
    - IPv6 设备间的消息：
      - 邻居请求 (NS) 消息
      - 邻居通告 (NA) 消息
      - 地址解析    
      当 LAN 上的设备知道目的 IPv6 单播地址，但不知道其以太网 MAC 地址时，会使用地址解析。要确定目的 MAC 地址，设备会将 NS 消息发送到请求节点地址。该消息包括已知（目标）IPv6 地址。具有目标 IPv6 地址的设备会使用包含其以太网 MAC 地址的 NA 消息进行回应。类似于IPv4的ARP
      - 重复地址检测    
      当设备分配有全球单播或本地链路单播地址时，则建议对地址执行 DAD 来确保其唯一性。如图 3 所示，要检查地址的唯一性，设备将发送 NS 信息，其中使用自身 IPv6 地址作为目标 IPv6 地址。如果网络中的其他设备具有该地址，则会使用 NA 消息进行响应。此 NA 消息通知发送方设备地址已在使用。如果回应的 NA 消息未在固定的一段时间返回，则单播地址是唯一的，可以使用。
2. Ping - 测试本地协议栈         
  - Ping 本地环回     
  从 127.0.0.1 接收的 IPv4 响应或从 ::1 接收的 IPv6 响应，表示主机上的 IP 安装正确。此响应来自网络层。但是，此响应并不代表地址、掩码或网关配置正确。它也不能说明有关网络协议栈下层的任何状态。它只测试 IP 网络层的 IP 连接。
3. tracerout - 测试路径   
Traceroute (tracert) 实用程序可以生成沿着路径成功到达的跳数列表。此列表可以提供重要的验证和故障排除信息。如果数据到达目的地，则 Trace 就会列出主机之间的路径中每台路由器上的接口。如果数据在沿途的某一跳上失败，则回应 Trace 的最后一个路由器的地址可以提供指示，说明发现问题或有安全限制的地方。      
Traceroute 使用第 3 层报头中的 IPv4 TTL 字段功能和 IPv6 跳数限制字段功能以及 ICMP 超时消息。    
从 Traceroute 发送的第一个消息序列的 TTL 字段值为 1。这会导致此 TTL 使 IPv4 数据包在第一台路由器处超时。然后，此路由器用 ICMPv4 消息做出响应。现在，Traceroute 知道了第一跳的地址。
随后，Traceroute 逐渐增加每个消息系列的 TTL 字段值（2、3、4...）。这可为 Trace 提供数据包在该路径沿途再次超时所经过的每一跳的地址。TTL 字段的值将不断增加，直至到达目的主机或增至预定义的最大值。
到达最终目的主机后，该主机将不再以 ICMP 超时消息做出应答，而会以 ICMP 端口无法到达消息或 ICMP 回应应答消息做出应答。
