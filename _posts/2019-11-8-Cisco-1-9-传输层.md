---
title: Cisco-1-9 传输层
auther: 雁引愁心去
layout: post
---


## 第九章 传输层 ##





### 第一节 传输层协议 ###

传输层负责在两个应用程序之间建立临时通信会话和在它们之间传递数据。应用程序生成从源主机的应用程序发送到目的主机的应用程序的数据。这不考虑目的主机类型、数据必须通过的介质类型、数据使用的路径、链路拥塞情况或网络大小。   

1. 传输层的职责

  - 跟踪各个会话 - 在传输层中，源应用程序和目的应用程序之间传输的每个数据集称为会话（图 1）。每台主机上都可以有多个应用程序同时在网络上通信。每个应用程序都与一台或多台远程主机上的一个或多个应用程序通信。传输层负责维护并跟踪这些会话。   

  - 数据分段和数据段重组    
  数据必须准备好用易管理的片段通过介质发送出去。大多数网络对单个数据包能承载的数据量都有限制。传输层协议的服务可将应用程序数据分为大小适中的数据块（图 2）。该服务包括每段数据所需的封装功能。报头用于重组，每个数据块都会添加一个报头。此报头用于跟踪数据流。      
  数据片段到达目的设备后，传输层必须能将其重组为可用于应用层的完整数据流。传输层协议规定了如何使用传输层报头信息来重组要传送到应用层的数据片段。

  - 标识应用程序 - 为了将数据流传送到适当的应用程序，传输层必须要标识目标应用程序（图 3）。因此，传输层为每一个应用程序分配一个标识符，称为端口号。在每台主机中，每个需要访问网络的软件进程都将被分配一个唯一的端口号。

2. 会话多路复用 - 多个应用同时使用网络    

  数据被分割成更小的块，在同一网络上交替（多路复用）实现不同用户的不同通信。
  为了识别每段数据，传输层向几个字段添加包含二进制数据的报头。不同的传输层协议通过这些字段值在管理数据通信过程中执行各自的功能。

3. 传输层可靠性   

  传输层还负责管理会话的可靠性要求。不同的应用程序有不同的传输可靠性要求。    

  IP 只涉及数据包的结构、地址分配和路由。IP 不指定数据包的传送或传输方式。传输协议则 __指定在主机之间传输报文的方式__。如图所示，TCP/IP 提供两种传输层协议，即 __传输控制协议 (TCP)__ 和 __用户数据报协议 (UDP)__。IP 使用这些传输协议来实现主机的数据通信和传输。    

  TCP 被认为是可靠且功能齐全的传输层协议，用于确保所有数据到达目的设备。但是，这需要 TCP 报头中包含其他字段，这会增加数据包的大小，同时也会增加延迟。相反，UDP 是不提供可靠性的一个比较简单的传输层协议。因此，UDP 的字段较少而且比 TCP 更快。

  - TCP     
  TCP 传输类似于从源到目的地跟踪发送的数据包。       
  使用 TCP 的三项基本的可靠性操作：   
    1. 计算并跟踪从特定应用程序发送到特定主机的数据段的数量。
    2. 确认收到数据
    3. 在一定时间段后，重新发送任何未确认的数据。

  -  UDP    
  UDP 仅提供在相应应用程序之间传输数据段的基本功能，需要很少的开销和数据检查。UDP 是一种尽力传输协议。在网络环境中，尽力传输被称为不可靠传输，因为它缺乏目的设备对所收到数据的确认机制。UDP 中没有通知发送方是否成功传输的传输层流程。      

  3. TCP 功能
  - 建立会话 - TCP 是一种面向连接的协议。面向连接的协议在转发任何流量之前，在源设备和目的设备之间协商并建立永久连接（或会话）。通过建立会话，设备可以协商特定时间能够转发的流量，而且两个设备之间的通信数据可得到严格管理。
  - 可靠传输 - 在网络术语中，可靠性指确保从源设备发送的每个数据段都能够到达目的设备。由于多种原因，数据段在网络传输过程中可能会损坏或者完全丢失。
  - 同序传输 - 由于网络可能提供了多条路由，每条路由又有不同的传输速率，所以可能导致数据抵达的顺序错乱。通过对数据段编号和排序，TCP 可以确保按正确的顺序重组这些数据段。
  - 流量控制 - 网络主机的内存或处理能力等资源有限。当 TCP 发现这些资源超负荷运转时，它可以请求源应用程序降低数据流速。为此，TCP 会调整源设备传输的数据量。流量控制可避免当接收主机的资源不堪重负时，数据的重新传输。

3. TCP报头    
  TCP 是一种状态协议。状态协议是跟踪通信会话状态的协议。为了跟踪会话的状态，TCP 记录已发送的信息和已确认的信息。状态会话开始于会话建立时，结束于会话终止时。   
![9-TCP数据段.png](/assets/images/cisco1/9-TCP数据段.png)

  每个 TCP 数据段都有 20 字节的开销用于在报头中封装应用层数据。
    - 源端口（16 位）和目的端口（16 位）- 用于识别应用程序。
    - 序列号（32 位）- 用于数据重组。
    - 确认号（32 位）- 指示数据已收到并指示预期来自源的下一个字节。
    - 报头长度（4 位）- 称为“数据偏移量”。表示 TCP 数据段报头的长度。
    - 保留（6 位）- 此字段留作将来使用。
    - 控制位（6 位）- 包括位码或标志，表示 TCP 数据段的用途和功能。
    - 窗口大小（16 位）- 表示可以一次接受的字节的数量。
    - 校验和（16 位）- 用于数据段报头和数据的错误检查。
    - 紧急（16 位）- 表示数据是否紧急

4. UDP功能      

  用户数据报协议 (UDP) 是一种尽力传输协议。UDP 是一种轻型传输协议，提供与 TCP 相同的数据分段和重组功能，但是没有 TCP 所提供的可靠性和流量控制。

4. UDP报头    
![9-UDP数据报.png](/assets/images/cisco1/9-UDP数据报.png)
  UDP 是无状态协议，这意味着客户端和服务器都不会跟踪通信会话的状态。如果使用 UDP 作为传输协议时要求可靠性，必须由应用程序来处理可靠性。

  通过网络传输实时视频和语音的一个最重要的要求是数据持续高速传输。实时视频和语音应用程序能够容忍具有极小或没有明显影响的一些数据丢失，非常适合于 UDP.    

  UDP 中的通信数据段称为数据报。这些数据报通过传输层协议尽力传送。UDP 具有 8 字节的低开销.

5. 多个单独会话     

  传输层必须能够划分和管理具有不同传输要求的多个通信。用户希望能够同时收发电子邮件和即时消息、浏览网站和进行 VoIP 电话呼叫。尽管可靠性要求不同，这些应用程序仍将同时通过网络发送和接收数据。

  TCP 和 UDP 通过使用唯一标识应用程序的报头字段来管理这些多个同时进行的会话。这些 __唯一标识符就是端口号__。

6. 端口号    

  源端口号与本地主机上的始发应用程序相关联；而目的端口号则与远程主机上的目的应用程序相关联.

  - 源端口 - 源端口号由发送方设备动态生成，用于标识两台设备之间的会话。这就使多个会话能够同时发生。设备通常可以同时发送多个 HTTP 服务请求到 Web 服务器。根据源端口号可以跟踪每个单独的 HTTP 会话。   
  - 目的端口 - 客户端将目的端口号放到数据段内，以此通知目的服务器请求的是什么服务。例如，当客户端在目的端口中指定端口 80 时，接收该消息的服务器就知道请求的是 Web 服务。服务器可同时提供多个服务，例如在端口 80 上提供 Web 服务，并同时在端口 21 上提供建立文件传输协议 (FTP) 连接的服务。     

7. 套接字对   
![9-套接字对.png](/assets/images/cisco1/9-套接字对.png)

  源端口和目的端口都被置入数据段内，然后数据段封装于 IP 数据包内。IP 数据包中含有源 IP 地址和目的 IP 地址。源 IP 地址和源端口号的组合或者目的 IP 地址和目的端口号的组合，称为套接字。套接字用于标识客户端所请求的服务器和服务。    

  客户端套接字可能如下所示，其中 1099 代表源端口号：      
  192.168.1.5:1099        
  Web 服务器上的套接字则可能是：       
  192.168.1.7:80          
  这两个套接字组合在一起形成一个套接字对：      
  192.168.1.5:1099，192.168.1.7:80            

  有了套接字，一台客户端上运行的多个进程便可彼此区分，它们与同一服务器进程建立的多个连接也可以彼此区分。对于请求数据的应用程序而言，该源端口号就像是一个返回地址。传输层将跟踪此端口和发出该请求的应用程序，当返回响应时，传输层可以将其转发到正确的应用程序。      

8. 端口号组   

  端口号有如下不同类型：   
    - 公认端口（端口 0 到 1023）- 这些编号用于服务和应用程序。Web 浏览器、电子邮件客户端以及远程访问客户端等应用程序通常使用这些端口号。通过 __为服务器应用程序定义公认端口__ ，可以将客户端应用程序设定为请求特定端口及其相关服务的连接。    
![9-常见公认端口号.png](/assets/images/cisco1/9-常见公认端口号.png)

    - 注册端口（端口 1024 到 49151）- 这些端口号由 IANA 分配给请求实体以用于特定进程或应用程序。这些进程主要是用户选择安装的一些应用程序，而不是已经分配了公认端口号的常用应用程序。例如，思科已将端口 1985 注册为其热备份路由器协议 (HSRP) 进程。   
    - 动态或私有端口（端口 49152 到 65535） - 也称为临时端口。这些端口往往在开始连接服务时由 __客户端__ 操作系统动态分配。动态端口用于在通信期间识别客户端应用程序。    
    [IANA网站上端口号及相关应用的完整列表](http://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml)     

9. netstat命令    

  有些时候，需要了解联网主机中启用并运行了哪些活动 TCP 连接。Netstat 是一种重要的网络实用程序，可用来检验此类连接。如图所示，输入命令 netstat 可列出正在使用的协议、本地地址和端口号、外部地址和端口号以及连接的状态。

  默认情况下，netstat 命令会尝试将 IP 地址解析为域名，将端口号解析为公认应用程序。-n 选项可用于显示数字形式的 IP 地址和端口号。

### 第二节 TCP和UDP ###

1. TCP服务器进程   

  分配给特定端口的活动服务器应用程序应该是开放的，也就是说，传输层将接受并处理分配到该端口的数据段。所有发送到正确套接字地址的传入客户端请求都将被接受，数据将被传送到服务器应用程序。在同一服务器上可以同时开启很多端口，每个端口对应一个动态服务器应用程序。    

2. TCP连接的建立   

  在 TCP 连接中，主机客户端与服务器建立连接。

  ![9-TCP连接的建立.png](/assets/images/cisco1/9-TCP连接的建立.png)

  TCP 连接分三个步骤建立：
    - 第 1 步 - 源客户端请求与服务器进行客户端-服务器通信会话。
    - 第 2 步 - 服务器确认客户端-服务器通信会话，并请求服务器-客户端通信会话。
    - 第 3 步 - 源客户端确认服务器-客户端通信会话。

3. TCP会话终止    
![9-TCP连接的终止.png](/assets/images/cisco1/9-TCP连接的终止.png)

  若要关闭连接，数据段报头必须设置完成 (FIN) 控制标志。为终止每个单向 TCP 会话，需采用包含 FIN 数据段和确认 (ACK) 数据段的二次握手。因此，若要终止 TCP 支持的整个会话过程，需要实施四次交换，以终止两个双向会话。    

    - 第 1 步 - 当客户端的数据流中没有其他要发送的数据时，它将发送带 FIN 标志设置的数据段；
    - 第 2 步 - 服务器发送 ACK 信息，确认收到从客户端发出的请求终止会话的 FIN 信息；
    - 第 3 步 - 服务器向客户端发送 FIN 信息，终止从服务器到客户端的会话；
    - 第 4 步 - 客户端发送 ACK 响应信息，确认收到从服务器发出的 FIN 信息。

![9-TCP控制位字段.png](/assets/images/cisco1/9-TCP控制位字段.png)

4. TCP三次握手分析    

  主机跟踪会话过程中的每个数据段，并使用 TCP 报头信息交换已接收数据的相关信息。TCP 是全双工协议，每个连接都代表两个单向通信数据流或会话。若要建立连接，主机应执行三次握手。TCP 报头中的控制位指出了连接的进度和状态。    
  三次握手：
    - 确认目的设备存在于网络上；
    - 确认目的设备有活动的服务，并且正在源客户端要使用的目的端口号上接受请求；
    - 通知目的设备源客户端想要在该端口号上建立通信会话

    通信完成后，将关闭会话并终止连接。连接和会话机制保障了 TCP 的可靠性功能。TCP 数据段报头的控制位字段中的六位被称为标志。

5. TCP可靠性 - 按序传送    

  TCP 数据段到达目的地的顺序可能是混乱的。因此，为了让目的设备理解原始消息，将重组这些数据段，使其恢复原有顺序。每个数据包中的数据段报头中都含有序列号，便于进行数据重组。序列号代表 TCP 数据段的第一个数据字节。    

  在会话建立过程中，将设置初始序列号 (ISN)。此 ISN 表示该会话中传输到接收应用程序的字节起始值。在会话过程中，每传送一定字节的数据，序列号就随之增加。通过这样的数据字节跟踪，可以唯一标识并确认每个数据段，还可以标识丢失的数据段。    

  接收方的 TCP 进程将数据段中的数据存入缓存区，而数据段则按照正确的序列顺序进行排列，重组后发送到应用层。对于序列号混乱的数据段，将被保留以备后期处理。等缺失的数据段到达后，再来按顺序处理这些数据段。   

6. TCP流量控制 - 窗口大小和确认
  TCP 同时提供流量控制机制，即目的主机能够可靠地接受并处理的数据量。流量控制可以调整给定会话中源和目的地之间的数据流速，有助于保持 TCP 传输的可靠性。为此，TCP 报头包括一个称为“ __窗口大小__ ”的 16 位字段。

  ![9-TCP窗口大小示例.png](/assets/images/cisco1/9-TCP窗口大小示例.png)

  图中显示了一个窗口大小和确认的示例。窗口大小是 TCP 会话的 __目的设备一次可以接受和处理的字节数__ 。在本例中，PC B 用于 TCP 会话的初始窗口大小为 10,000 字节。从第 1 个字节开始，字节数为 1，PC A 在不收到确认的前提下可以发送的最后一个字节为 10,000。这就是 PC A 的发送窗口。每个 TCP 数据段均包含窗口大小，那样目的设备可以根据缓冲区的可用性随时修改窗口大小。   

  注意：如图所示，在每个 TCP 数据段内，源主机正在传输 1,460 字节的数据。我们将此称为 __MSS（最大数据段大小）__.       

  初始窗口大小在三次握手期间建立 TCP 会话时确定。源设备必须根据目的设备的窗口大小限制发送到目的设备的字节数。只有源设备收到字节数已接收的确认之后，才能继续发送更多会话数据。通常情况下，__目的设备不会等待其窗口大小的所有字节接收后才以确认应答__。接收和处理字节时，目的设备就会发送确认，以告知源设备它可以继续发送更多字节。

  通常情况下，PC B 不会等待所有 10,000 字节都接收后才发送确认。这就意味着 PC A 可以在收到 PC B 的确认时调整其发送窗口。如图所示，当 PC A 收到确认号为 2,921 的确认消息时，PC A 的发送窗口将另外增加 10,000 字节（PC B 的当前窗口大小），增加至 12,920。现在只要 PC A 发送不超出其新的发送窗口 12,920 的字节数，它就能够向 PC B 另外发送 10,000 字节。

  目的设备在处理接收的字节并不断调整源设备的发送窗口大小时发送确认的过程被称为滑动窗口。

  如果目的设备缓冲区空间的可用性减小，它可以缩减窗口大小，通知源设备减少发送的字节数，而不需要接收确认。

  注意：设备通常使用滑动窗口协议。使用滑动窗口时，接收方不会等待达到其窗口大小中的字节数后才发送确认。接收方通常在每收到 __两个数据段__ 之后发送确认。在确认之前收到的数据段的数量可能有所不同。滑动窗口的优势在于，只要接收方确认之前的数据段，就可以让发送方持续传输数据段。

7. TCP流量控制 - 避免拥塞   
![9-TCP拥塞控制.png](/assets/images/cisco1/9-TCP拥塞控制.png)
  网络中出现拥塞会使过载的路由器丢弃数据包。当包含 TCP 数据段的数据包未到达其目的地时，它们就成为未确认的数据包。通过确定 TCP 数据段发送但未确认的速率，源设备可以假设一定程度的网络拥塞。   

  出现网络拥塞时，从源设备丢失的 TCP 数据段就会重传。如果不适当控制重传，TCP 数据段的额外重传会使拥塞的情况更糟。网络中不仅有 TCP 数据段的新数据包，而且还有重传丢失的 TCP 数据段的反馈效果，这都增加了拥塞。为避免和控制拥塞，TCP 使用了多个拥塞处理机制、计时器和算法。

  如果源设备确定 TCP 数据段没有被确认或没有被及时确认，它会在收到确认之前减少发送的字节数。注意是源设备在减少其发送的未确认的字节数，而不是由目的设备来确定窗口大小。

8. UDP低开销与可靠性   

  UDP 是一种简单协议，提供基本的传输层功能。与 TCP 相比，UDP 的开销极低，因为 UDP 是无连接的，并且不提供能实现可靠性的重新传输、排序和流量控制等复杂机制。正是由于 UDP 的开销低，因此它很适合于进行简单请求和响应通信事务的协议。

9. UDP数据报重组   

  与 TCP 数据段类似，当将多个 UDP 数据报发送到目的主机时，它们通常采用不同的路径，到达顺序也可能跟发送时的顺序不同。UDP 不会按传输顺序重新排列数据报。因此，UDP 仅仅是将接收到的数据按照先来后到的顺序转发到应用程序。如果数据顺序对应用程序很重要，应用程序必须确定正确的顺序并决定如何处理数据。

10. UDP服务器进程与请求   

  与基于 TCP 的应用程序相同的是，基于 UDP 的服务器应用程序也被分配了公认端口号或注册端口号。当上述应用程序或进程在服务器上运行时，它们就会接受与所分配端口号相匹配的数据。当 UDP 收到用于某个端口的数据报时，它就会按照应用程序的端口号将数据发送到相应的应用程序。

11. UDP客户端进程    

  与 TCP 一样，客户端应用程序向服务器进程请求数据，便会发起客户端-服务器通信。UDP 客户端进程则是从可用端口号中动态挑选一个端口号，用来作为会话的源端口。而目的端口通常都是分配到服务器进程的公认端口号或注册端口号。    

  客户端选定了源端口和目的端口后，通信事务中的所有数据报头都采用相同的端口对。对于从服务器到达客户端的数据来说，数据报头所含的源端口号和目的端口号作了互换。   

12. 使用TCP的应用程序    

  TCP 很好地说明了 TCP/IP 协议簇的不同层如何拥有特定角色。TCP 处理与将数据流划分为数据段、提供可靠性、控制数据流量和数据段重新排序相关的所有任务。TCP 使应用程序不用再管理这些任务。如图所示的应用程序只需要将数据流发送到传输层和使用 TCP 提供的服务。   
![9-使用TCP的应用程序.png](/assets/images/cisco1/9-使用TCP的应用程序.png)

13. 使用UDP的应用程序

  最适合采用 UDP 协议的三种应用程序包括：
    - 实时视频和多媒体应用程序 - 可以容忍部分数据丢失但要求延迟极小或没有延迟的应用程序。示例包括 VoIP 和实时流传输视频。
    - 简单请求和应答应用程序 - 处理简单事务的应用程序，其中主机发送请求，但不一定收到应答。例如 DNS 和 DHCP。
    - 处理可靠性的应用程序 - 不要求进行流量控制、错误检测、确认和错误恢复，或这些功能由应用程序来执行的单向通信。例如 SNMP 和 TFTP。
  虽然 DNS 和 SNMP 默认使用 UDP，但它们都可以使用 TCP。如果 DNS 请求或 DNS 响应大于 512 字节，DNS 会使用 TCP，例如 DNS 响应包含大量域名解析时。同样，在某些情况下，网络管理员可以配置 SNMP 使用 TCP。

  ![9-使用UDP的应用程序.png](/assets/images/cisco1/9-使用UDP的应用程序.png)
