---
title: Cisco-1-6 网络层
auther: 雁引愁心去
layout: post
order: 6
---

## 第六章 网络层 ##






### 第一节 网络层协议 ###

1. 数据交换
为了实现这种端到端传输，网络层使用了四个基本过程：
  - 终端设备编址 - 必须为终端设备配置唯一的 IP 地址，以便在网络上进行识别。

  - 封装 - 网络层将来自传输层的 __协议数据单元 (PDU)__ 封装到数据包中。封装过程中会添加 IP 报头信息，例如来源（发送）和目的（接收）主机的 IP 地址。
  - 路由 - 网络层提供服务，将数据包转发至另一网络上的目的主机。要传送到其他网络，数据包必须经过路由器的处理。__路由器的作用是为数据包选择最佳路径，并将其转发至目的主机，该过程称为路由__。数据包可能需要经过很多中间设备才能到达目的主机。数据包在到达目的主机的过程中经过的每个路由器均称作 __一跳__
  - 解封 - 当数据包到达 __目的主机的网络层__ 时，主机会检查数据包的 IP 报头。如果在报头中的目的 IP 地址与其自身的 IP 地址匹配，__IP 报头将会从数据包中删除__。网络层解封数据包后，后继的 __第 4 层 PDU 会向上传递到传输层的相应服务__。  

  传输层（OSI 第 4 层）负责管理 __每台主机上的运行进程之间的数据传输__，而网络层协议则指定从一台主机向另一台主机传送数据时使用的 __数据包结构和处理过程__。
2. 封装IP
  - 分层封装数据层的流程使我们可以开发和扩展位于不同层的服务而不影响其他层。
  - 路由器可以实施不同的网络层协议，使其通过网络同时运行。这些中间设备所执行的路由只考虑网络层数据包报头的内容。
3. IP特征
  - 无连接
  IP 在转发数据包前，并不需要初步交换控制信息来创建端到端连接。IP 也不需要报头中包含其他字段来维持建立的连接。

  - 最大努力
  不可靠表示 IP 不具备管理和恢复未送达数据包或已损坏数据包的能力。在 TCP/IP 协议簇中，__传输层负责保证可靠性__。
  - 介质无关性  

    IP 数据包的传输不限于任何特定的介质。网络层会考虑介质的一个重要特征：每种介质可以传输的最大 PDU 大小。此特征称 为 __最大传输单位 (MTU)__。数据链路层和网络层之间的 __部分控制通信__ 就是确定数据包的最大尺寸。数据链路层将 MTU 值向上传送到网络层。网络层会由此确定可以传送的数据包的大小。

    有时，中间设备（通常是路由器），在 __将数据包从一个介质转发到具有更小 MTU 的介质__ 时，必须分割数据包。此过程称为 __数据包分段或分段__.

  IP 被设计为一种低开销协议。它只提供通过互连网络系统从源主机向目的主机传送数据包所必需的功能。该协议并不负责跟踪和管理数据包的流动。

4. IPv4 数据包报头

![IPv4数据包报头](/assets/images/cisco1/6-IPv4数据包报头.png)

  IPv4 报头中的重要字段包括：
    - 版本 - 包含一个 4 位二进制值 __0100__，用于标识这是 IPv4 数据包
    - 区分服务或 DiffServ (DS) - 以前称为服务类型 (ToS) 字段，DS 字段是一个用于确定每个 __数据包优先级__ 的 8 位字段。DiffServ 字段的 __六个最高有效位是区分服务代码点 (DSCP)__，而 __后两位是显式拥塞通知 (ECN) 位__。
    - 生存时间 (TTL) - 包含用于限制数据包寿命的一个 __8 位二进制值(共256)__。数据包发送方设置初始 TTL 值，__数据包每经过一次路由器处理，数值就减少一__。如果 TTL 字段的值减为零，则路由器将丢弃该数据包并向源 IP 地址发送 Internet 控制消息协议 (ICMP) 超时消息

    - 协议 - 字段用于确定 __下一级协议__。此 8 位二进制值表示数据包包含的 __数据负载类型__，使网络层将数据传送到相应的 __上层协议__。常用的值包括 __ICMP (1)、TCP (6) 和 UDP (17)__
    - 源 IPv4 地址 - 源 IPv4 地址始终为单播地址
    - 目的 IPv4 地址 -目的 IPv4 地址为单播、组播或广播地址
5. IPv4局限性
  - IP 地址耗尽 - 大约 40 亿的 IPv4 地址

  - Internet 路由表膨胀 - IPv4 路由消耗 Internet 路由器上的大量内存和处理器资源
  - 缺乏端到端连接 - __网络地址转换 (NAT)__ 是 IPv4 网络中经常实施的一项技术。NAT 为多种设备共享单一的公有 IPv4 地址提供方法。但是，因为共享了公有 IPv4 地址，内部网络主机的 IPv4 地址会隐藏起来。
6. IPv6简介

  IPv6 的功能提升包括：

    - 更大的地址空间 - IPv6 地址基于 128 位分层编址，而 IPv4 采用的是 32 位
    - 改进数据包处理过程 - IPv6 报头简化为更少的字段。

    - 消除了对 NAT 的需求 - 有了数额如此巨大的公有 IPv6 地址，私有 IPv4 地址和公有 IPv4 地址之间不再需要 NAT。
7. IPv6 数据包报头   

![IPv6数据包报头](/assets/images/cisco1/6-IPv6数据包报头.png)

  IPv6 数据包报头中的字段包括：
    - 版本 - 此字段包含一个 4 位二进制值 __0110__，用于标识这是 IPv6 数据包
    - 流量类别 - 此 8 位字段相当于“IPv4 区分服务 (DS)”字段

    - 流量标签 - 此 20 位字段建议带有相同流量标签的所有数据包收到路由器的相同处理
    - 负载长度 - 此 16 位字段表示 IPv6 数据包的数据部分或负载的长度
    - 下一报头 - 此 8 位字段相当于“IPv4 协议”字段。它表示数据包传送的 __数据负载类型，使网络层将数据传送到相应的上层协议__
    - 跳数限制 - 此 8 位字段取代 IPv4 的 TTL 字段
    - 源 IPv6 地址
    - 目的 IPv6 地址      

  IPv6 数据包还可能包含扩展报头 (EH)，以便提供可选的网络层信息。扩展报头为可选项，位于 IPv6 报头及负载之间.与 IPv4 不同，路由器不会对路由的 IPv6 数据包进行分段

### 第二节 路由 ###
1. 主机转发抉择

  如果主机发送数据包到与主机设备配置有相同 IP 网络的设备，则数据包仅是转发出主机接口，然后经过中间设备即可直接到达目的设备  

  如果源设备发送数据包到远程目的设备，则需要借助路由器和路由。__路由是确定到达目的之最佳路径的过程__。连接到本地网段的路由器称为 __默认网关__。

2. 默认网关

  默认网关是可以将流量路由到其他网络的网络设备

  主机的路由表通常包括默认网关。主机通过动态主机配置协议 (DHCP) 动态接收默认网关 IPv4 地址，或者通过手动配置.默认路由是计算机尝试联系远程网络时所用的路由或路径。

3. IPv4主机路由表

  netstat -r  
  命令显示有关当前 TCP/IP 网络连接的三个部分：

    - 接口列表 - 列出主机上的介质访问控制 (MAC) 地址和每个网络接口的已分配接口编号，包括以太网、Wi-Fi 和蓝牙适配器

    - IPv4 路由表 - 列出所有已知的 IPv4 路由，包括直接连接、本地网络和本地默认路由
    - IPv6 路由表 - 列出所有已知的 IPv6 路由，包括直接连接、本地网络和本地默认路由
4. 路由器数据包转发抉择

  当一台主机发送数据包到另一台主机时，它将使用路由表来确定将数据包发送到哪里.如果目的主机位于远程网络，则数据包会转发到默认网关.路由器会查看路由表来确定将数据包转发到哪里.路由器的路由表存储下列信息:
    - 直连路由 - 这些路由来自于活动的 __路由器接口__。当 __接口配置了 IP 地址并激活__ 时，路由器会添加直连路由。路由器的每个接口均连接到一个不同的网段.
    - 远程路由 - 这些路由来自连接到 __其他路由器__ 的远程网络.

    - 默认路由 - 与主机一样，如果路由表中没有通向目标网络的其他路由，路由器也会将默认路由作为最后选用网关
5. IPv4路由器路由表

  show ip route
  在 Cisco IOS 路由器上，show ip route 命令可用于显示路由器的 IPv4 路由表.
  除了为直连网络和远程网络提供路由信息，路由表还包括其他一些信息，比如 _路由获取方式_、_路由的可信度和等级_、_上次更新路由的时间_ 以及 _到达请求的目的地所使用的接口_
    - 直连路由表条目

    ![直连路由表条目](/assets/images/cisco1/6-直连路由表条目.png)

    为路由器接口配置 IPv4 地址、子网掩码并激活时，将会自动创建以下两个路由表条目：
      - C - 用于确定 __直连网络__。为接口配置 IP 地址并激活时，会自动创建直连网络

      - L - 表示这是 __本地接口__。这是路由器接口的 IPv4 地址
      - GigabitEthernet 0/0 - 传出接口.用于确定转发数据包到最终目的地二出接口.

    - 远程路由表条目

    ![远程路由表条目](/assets/images/cisco1/6-远程网路路由表条目.png)

      - D - 路由来源.常见的路由来源包括 S(静态路由),D(增强型呢不网关路由选择协议),O(开放型最短路径优先)

      - 10.1.1.0/24 - 确定目的网络
      - 90 - 管理距离.确定路由来源的管理距离(即可信度).值越低表示路由来源的可信度越高.
      - 2170112 - 度量.用于确定为到达远程网络所分配的值.值越低表示此路由越佳.
      - 209.165.200.226 - 下一跳.用于确定转发数据包的下一路由器的IP地址.
      - 00:00:05 - 路由时间戳.用于识别路由最后一次帧厅的时间.
      - Serial10/0/0 - 用于确定转发数据包最终目的地的出接口.  

    路由器不能转发 __目的网络与路由表中的路由不匹配的数据包__。如果路由表中没有代表目的网络的路由，会丢弃数据包（即不转发）。但是，正如主机 __可以使用默认网关将数据包转发到未知目的地址__，__路由器也可以包含默认路由，以创建最后选用网关__

### 第三节 路由器 ###
  所有路由器型号实质上都是计算机。和计算机、平板电脑和智能设备一样，路由器也需要：
  -
    - 中央处理器 (CPU)
    - 操作系统 (OS)
    - 随机访问存储器 (RAM)
    - 只读存储器 (ROM)
    - 非易失性随机访问存储器 (NVRAM)
    - 闪存(FLASH)

1. 路由存储器

![路由存储器](/assets/images/cisco1/6-路由存储器.png)

  - RAM - 用于存储 CPU 执行的应用程序、进程和数据
    - IOS映像和运行配置文件

    - 用于确定转发数据包的最佳路径的路由表
    - 用于将IPv4地址映射到MAC地址的ARP缓存
    - 用于在转发到目的地之前临时存储数据包的数据包缓存
  - ROM - 这种非易失性存储器用于存储重要的操作指令和有限的 IOS
    - 提供启动说明的启动信息

    - 测试所有硬件组件的开机自检(POST)
    - 提供IOS备份版本的受限IOS.他用于在全功能IOS被删除或损坏时加载全功能IOS.

  - NVRAM – 这种非易失性存储器可用作 __启动配置文件__ (startup-config) 的永久性存储器
  - 闪存 - 这种非易失性计算机存储器可用作 IOS 和其他系统相关文件的永久性存储器，比如日志文件、语音配置文件、HTML 文件、备份配置及其他内容。当路由器重启时，IOS 从闪存复制到 RAM 中.

2. 带内路由器接口和管理端口
  - 带内路由器接口
    - 以太网LAN接口 - 用于连接其他支持以太网的设备包括交换机,路由器防火墙等.每个LAN接口都有自己的IPv4地址和子网掩码和/或IPv6地址和前缀这些可将接口标识为特定网络的成员.

    - 串行WAN接口 - 串行接口用于将路由器连接到外部WAN网络.每个串行WAN接口都有自己的IP地址和子网掩码,这些可将接口标识为特定网络的成员.
  - 管理端口
    - 控制台 – 这是一种物理管理端口，可通过该端口对思科设备进行带外访问.带外访问是指通过仅用于设备维护的专用管理通道进行访问

    - 安全外壳 (SSH) – SSH 是使用虚拟接口通过网络远程建立安全 CLI 连接的方法。不同于控制台连接，SSH 连接需要设备上 __具有有效的网络服务，包括配置了地址的有效接口__.
    - Telnet - Telnet 使用虚拟接口通过网络远程建立 CLI 会话，这种方法并不安全。不同于 SSH，Telnet __不提供经过加密的安全连接__。用户身份验证、密码和命令通过网络以明文形式发送。  
  Telnet 和 SSH 要求带内网络连接，这意味着管理员必须通过其中一个 WAN 或 LAN 接口访问路由器

3. 路由器启动过程

![路由器启动过程](/assets/images/cisco1/6-路由器启动过程.png)

  1. 执行 POST 和加载引导程序

    - 在加电自检 (POST) 过程中，路由器会通过 ROM 对若干硬件组件进行诊断，包括 CPU、RAM 和 NVRAM。POST 完成后，__引导程序__ 将从 ROM 复制到 RAM。引导程序的主要任务是查找 Cisco IOS 并将其加载到 RAM
  2. 查找并加载 Cisco IOS

    - IOS 通常存储在 __闪存__ 中，由 CPU 将其复制到 RAM 进行执行。如果闪存中没有找到 IOS 映像，则路由器可以使用简单文件传输协议 (TFTP) 服务器进行查找。如果找不到完整的 IOS 映像，有限的 IOS 将复制到 RAM，这可用于诊断问题并将完整的 IOS 传输到闪存中

  3. 查找并加载配置文件

    - 引导程序将启动配置文件从 NVRAM 复制到 RAM 中。该文件随即 __成为运行配置__。如果 NVRAM 中不存在启动配置文件，则路由器可能会配置为搜索 TFTP 服务器。如果未找到 TFTP 服务器，则路由器显示设置模式提示

4. show version输出

  show version 命令会显示路由器当前所运行的 Cisco IOS 软件的版本信息、引导程序版本信息以及硬件配置信息（包括系统存储器大小）

### 第4节 配置思科路由器 ###
1. 交换机配置任务
  - 配置设备名称
    - hostname sw_name
  - 保护用户模式
    - line console 0
    - password passwd
    - login
  - 保护远程Telnet/SSH访问
    - line vty 0 15
    - password passwd
    - login
  - 保护特权模式
    - enable secret passwd
  - 保护配置文件中的所有密码
    - service password-encryption
  - 提供约定通知
    - banner motd delimiter message delimiter
  - 配置管理 SVI
    - intertface vlan 1
    - ip address ip-address subnet-mask
    - no shutdown
  - 保存配置
    - copy running-config startup-config
            enable
            configure terminal
            hostname S1
            enable secret class
            line console 0
            password cisco
            login
            exit
            service password-encryption
            banner motd #No unauthorzed access allowed!#
            intertface vlan 1
            ip address 192.168.10.50 255.255.255.0
            no shutdown
            end
            copy running-config startup-config

2. 路由器配置步骤

  - 配置设备名称
    - hostname 名称
  - 保护用户模式
    - line console 0
    - password 口令
    - login
  - 保护远程Telnet/SSH访问
    - line vty 0 15
    - password 口令
    - login
  - 保护特权模式
    - enable secret 口令
  - 保护配置文件中的所有密码
    - service password-encryption
  - 提供约定通知
    - banner motd delimiter message delimiter
  - 保存配置
    - copy running-config startup-config
3. 配置路由器接口
  - intertface type-and-number
  - description description-text
  - ip address ipv4-address subnet-mask
  - no shutdown
          int g0/1
          ip add 192.168.11.1 255.255.255.0
          des Link to LAN-11
          no shut

4. 检验接口配置

  `show ip intertface brief`  

  生成的输出显示所有接口、其 IPv4 地址和当前状态。已配置和连接的接口的状态和协议均会显示“up”。显示任何其他内容均表示配置或布线出现问题。  
  可以使用 ping 命令验证接口连接。思科路由器发送五个连续的 ping，并测量最小、平均和最大往返时间。感叹号用于验证连接。
  其他接口验证命令包括：
    - show ip route - 显示存储在 RAM 中的 IPv4 路由表的内容
    - show interfaces - 显示设备上所有接口的统计信息
    - show ip interface - 显示路由器上所有接口的 IPv4 统计信息
5. 主机的默认网关
6. 交换机的默认网关

  在希望通过 __本地网络之外__ 的方式通信的所有设备上，一般都会配置默认网关地址。换句话说，若要使用 SSH 或 Telnet 从其他网络远程访问交换机，交换机必须具有 __配置了 IPv4 地址、子网掩码和默认网关地址的 SVI__。

  要为交换机配置默认网关，请使用 __ip default-gateway 全局配置命令__。配置的 IP 地址是相连交换机的 __路由器接口的 IP 地址__

  常见误解是，对于来源为与交换机相连的主机且目的地为远程网络中的主机的数据包，交换机会使用自身配置的默认网关地址来确定转发数据包的目的地。实际上，IP 地址和默认网关信息仅用于来源为交换机的数据包。来自与交换机相连的主机计算机的数据包必须在主机计算机操作系统上配置默认网关地址。
